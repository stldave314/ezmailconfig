#!/bin/bash

# ezmailconfig - Easy Mail Configuration Utility
# Configure system-wide or user-level email sending using msmtp

VERSION="0.1.0"
CONFIG_FILE="$HOME/.msmtprc"
LOG_FILE="$HOME/.ezmailconfig.log"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Default values
INTERACTIVE=true
TEST_MODE=false
PROVIDER=""
EMAIL=""
PASSWORD=""
SMTP_HOST=""
SMTP_PORT=""
AUTH_METHOD="on"
TLS="on"

log() {
    echo -e "$(date '+%Y-%m-%d %H:%M:%S') - $1" >> "$LOG_FILE"
}

info() {
    echo -e "${BLUE}[INFO]${NC} $1"
    log "[INFO] $1"
}

success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
    log "[SUCCESS] $1"
}

warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
    log "[WARN] $1"
}

error() {
    echo -e "${RED}[ERROR]${NC} $1"
    log "[ERROR] $1"
}

# --- Dependency Management ---

check_command() {
    command -v "$1" >/dev/null 2>&1
}

detect_package_manager() {
    if check_command apt-get; then
        echo "apt"
    elif check_command dnf; then
        echo "dnf"
    elif check_command pacman; then
        echo "pacman"
    elif check_command zypper; then
        echo "zypper"
    elif check_command apk; then
        echo "apk"
    else
        echo "unknown"
    fi
}

install_dependencies() {
    local pm=$(detect_package_manager)
    local packages_needed=()
    
    if ! check_command msmtp; then
        packages_needed+=("msmtp")
    fi
    if ! check_command msmtp-mta; then
         # Check if 'sendmail' is actually provided by msmtp
         if ! ls -l $(which sendmail 2>/dev/null) | grep -q msmtp;
 then
             # On some systems msmtp-mta is a separate package or alias
             packages_needed+=("msmtp-mta") 
         fi
    fi
    if ! check_command whiptail; then
        packages_needed+=("whiptail")
    fi
    # ca-certificates is usually present but good to ensure
    if ! check_command update-ca-certificates; then
         packages_needed+=("ca-certificates")
    fi

    if [ ${#packages_needed[@]} -eq 0 ]; then
        info "All dependencies are installed."
        return 0
    fi

    info "Installing missing dependencies: ${packages_needed[*]}..."
    
    case "$pm" in
        apt)
            sudo apt-get update && sudo apt-get install -y "${packages_needed[@]}" msmtp-mta
            ;;
        dnf)
            sudo dnf install -y "${packages_needed[@]}"
            ;;
        pacman)
            sudo pacman -Sy --noconfirm "${packages_needed[@]}"
            ;;
        apk)
             sudo apk add "${packages_needed[@]}"
             ;;
        *)
            error "Unsupported package manager. Please install: ${packages_needed[*]} manually."
            exit 1
            ;;
    esac
}

# --- Configuration Logic ---

configure_gmail() {
    SMTP_HOST="smtp.gmail.com"
    SMTP_PORT="587"
    TLS="on"
    AUTH_METHOD="on"
    
    if [ "$INTERACTIVE" = true ]; then
        whiptail --title "Gmail Configuration" --msgbox "For Gmail, it is highly recommended to use an 'App Password' rather than your main password.\n\n1. Go to https://myaccount.google.com/security\n2. Enable 2-Step Verification if not active.\n3. Search for 'App passwords'.\n4. Create a new one for 'Mail' and this device.\n5. Use that 16-character code as the password in the next step." 15 70
    fi
}

configure_outlook() {
    SMTP_HOST="smtp.office365.com"
    SMTP_PORT="587"
    TLS="on"
    AUTH_METHOD="on"
}

configure_proton() {
    # ProtonMail typically requires Proton Mail Bridge running locally
    if [ "$INTERACTIVE" = true ]; then
        whiptail --title "Proton Mail" --msgbox "Proton Mail requires the 'Proton Mail Bridge' to be installed and running on this machine.\n\nWe will configure msmtp to talk to your local Bridge.\nPlease ensure Bridge is running and you have your Bridge password ready (NOT your login password)." 15 70
    fi
    SMTP_HOST="127.0.0.1"
    SMTP_PORT="1025" # Default Bridge port
    TLS="off" # Bridge handles encryption, local connection usually plaintext or STARTTLS. msmtp often needs tls=off or special config for localhost bridge self-signed certs.
    # Actually Bridge usually supports STARTTLS on 1025. Let's try standard.
    # Often Bridge users need 'tls_starttls on' and 'tls_trust_file' or disable verification.
}

write_config() {
    local user="$1"
    local pass="$2"
    local host="$3"
    local port="$4"
    local from="$1" # Default from to user

    # Backup existing
    if [ -f "$CONFIG_FILE" ]; then
        cp "$CONFIG_FILE" "${CONFIG_FILE}.bak.$(date +%s)"
    fi

    cat > "$CONFIG_FILE" <<EOF
# Generated by ezmailconfig
defaults
auth           $AUTH_METHOD
tls            $TLS
tls_trust_file /etc/ssl/certs/ca-certificates.crt
logfile        $LOG_FILE

account default
host           $host
port           $port
from           $from
user           $user
password       $pass
EOF
    
    # Specific tweak for Proton Bridge (often needs self-signed support or specific cert)
    if [ "$PROVIDER" = "proton" ]; then
         # Proton Bridge usually handles TLS but certificate validation can fail on localhost
         echo "tls_certcheck off" >> "$CONFIG_FILE"
    fi

    chmod 600 "$CONFIG_FILE"
    success "Configuration written to $CONFIG_FILE"
}

# --- Interactive Wizard ---

show_gui() {
    install_dependencies

    # 1. Choose Provider
    PROVIDER=$(whiptail --title "Select Email Provider" --menu "Choose your email service provider:" 15 60 5 \
        "gmail" "Gmail (Google)" \
        "outlook" "Outlook / Office 365" \
        "proton" "Proton Mail (requires Bridge)" \
        "custom" "Manual SMTP Configuration" 3>&1 1>&2 2>&3)

    if [ -z "$PROVIDER" ]; then exit 0; fi

    # 2. Get Credentials
    EMAIL=$(whiptail --title "Email Address" --inputbox "Enter your full email address:" 10 60 3>&1 1>&2 2>&3)
    if [ -z "$EMAIL" ]; then exit 0; fi

    case "$PROVIDER" in
        gmail) configure_gmail ;; 
        outlook) configure_outlook ;; 
        proton) configure_proton ;; 
        custom)
            SMTP_HOST=$(whiptail --title "SMTP Host" --inputbox "Enter SMTP Host (e.g., smtp.example.com):" 10 60 3>&1 1>&2 2>&3)
            SMTP_PORT=$(whiptail --title "SMTP Port" --inputbox "Enter SMTP Port (usually 587 or 465):" 10 60 "587" 3>&1 1>&2 2>&3)
            ;;
    esac

    PASSWORD=$(whiptail --title "Password" --passwordbox "Enter your password (or App Password):" 10 60 3>&1 1>&2 2>&3)
    if [ -z "$PASSWORD" ]; then exit 0; fi

    write_config "$EMAIL" "$PASSWORD" "$SMTP_HOST" "$SMTP_PORT"
    
    if whiptail --title "Test Configuration" --yesno "Would you like to send a test email now?" 10 60; then
        send_test_email "$EMAIL"
    fi
}

# --- CLI & Utility Functions ---

send_test_email() {
    local recipient="$1"
    info "Sending test email to $recipient..."
    if ! check_command msmtp; then
        error "msmtp not found. Cannot send mail."
        return 1
    fi

    echo -e "Subject: Test Email from ezmailconfig\n\nThis is a test email sent on $(date)." | msmtp "$recipient"
    if [ $? -eq 0 ]; then
        success "Test email sent successfully!"
        if [ "$INTERACTIVE" = true ]; then
            whiptail --title "Success" --msgbox "Test email sent successfully to $recipient" 10 60
        fi
    else
        error "Failed to send test email. Check $LOG_FILE for details."
        if [ "$INTERACTIVE" = true ]; then
             whiptail --title "Error" --msgbox "Failed to send test email. Check logs." 10 60
        fi
    fi
}

usage() {
    echo "Usage: ezmailconfig [OPTIONS]"
    echo "Options:"
    echo "  --gui               Start the interactive configuration wizard (default if no args)"
    echo "  --test <email>      Send a test email to the specified address"
    echo "  --user <email>      Set email username (CLI mode)"
    echo "  --pass <pass>       Set email password (CLI mode)"
    echo "  --host <host>       Set SMTP host (CLI mode)"
    echo "  --port <port>       Set SMTP port (CLI mode)"
    echo "  --help              Show this help message"
}

# --- Main Execution ---

# Check if arguments provided
if [ $# -eq 0 ]; then
    show_gui
    exit 0
fi

# Parse Arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        --gui)
            show_gui
            exit 0
            ;;
        --test)
            TEST_RECIPIENT="$2"
            shift 2
            send_test_email "$TEST_RECIPIENT"
            exit 0
            ;;
        --user)
            EMAIL="$2"
            shift 2
            ;;
        --pass)
            PASSWORD="$2"
            shift 2
            ;;
        --host)
            SMTP_HOST="$2"
            shift 2
            ;;
        --port)
            SMTP_PORT="$2"
            shift 2
            ;;
        --help)
            usage
            exit 0
            ;;
        *)
            error "Unknown argument: $1"
            usage
            exit 1
            ;;
    esac
done

# CLI Configuration Mode
if [ -n "$EMAIL" ] && [ -n "$PASSWORD" ] && [ -n "$SMTP_HOST" ] && [ -n "$SMTP_PORT" ]; then
    INTERACTIVE=false
    install_dependencies
    write_config "$EMAIL" "$PASSWORD" "$SMTP_HOST" "$SMTP_PORT"
else
    error "Missing arguments for CLI configuration. Need --user, --pass, --host, and --port."
    exit 1
fi
